import nodemailer from 'nodemailer';
import fs from 'fs';
import path from 'path';

async function main() {
    try {
        console.log('Creating Ethereal test account...');
        const testAccount = await nodemailer.createTestAccount();

        console.log('Account created!');
        console.log('User:', testAccount.user);
        console.log('Pass:', testAccount.pass);

        const envPath = path.join(process.cwd(), '.env');
        let envContent = fs.readFileSync(envPath, 'utf-8');

        // Regex to find and replace SMTP config, or append if missing
        const smtpConfig = `
# SMTP Configuration (Generated by Ethereal)
SMTP_HOST="smtp.ethereal.email"
SMTP_PORT="587"
SMTP_USER="${testAccount.user}"
SMTP_PASS="${testAccount.pass}"
SMTP_FROM="no-reply@kapdafactory.com"
`;

        // Remove existing SMTP keys if they exist to avoid duplicates
        envContent = envContent.replace(/^SMTP_.*$/gm, '');
        // Clean up empty newlines left by replace
        envContent = envContent.replace(/\n\s*\n/g, '\n');

        // Append new config
        fs.writeFileSync(envPath, envContent + smtpConfig);
        console.log('Updated .env with Ethereal credentials.');

    } catch (err) {
        console.error('Failed to create account:', err);
    }
}

main();
